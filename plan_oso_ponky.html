<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan Inteligente Oso & Ponky</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    * { box-sizing: border-box; }
    body { margin: 0; background: #0b0f14; color: #e9eef7; }
    header { padding: 16px 16px 10px; position: sticky; top: 0; background: rgba(11,15,20,.92); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.08); z-index: 100; }
    h1 { margin: 0 0 6px; font-size: 20px; font-weight: 700; }
    .sub { opacity: .75; font-size: 12px; line-height: 1.35; }
    main { padding: 14px 16px 90px; max-width: 880px; margin: 0 auto; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 860px) { .row { grid-template-columns: 1.2fr .8fr; } }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 14px; opacity: .9; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 999px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); font-size: 12px; }
    .grid2 { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .btn { cursor:pointer; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.08); color:#e9eef7; padding:10px 12px; border-radius: 12px; font-weight: 600; }
    .btn:hover { background: rgba(255,255,255,.12); }
    .btn.danger { background: rgba(255,40,40,.14); border-color: rgba(255,80,80,.25); }
    .btn.primary { background: rgba(80,160,255,.20); border-color: rgba(80,160,255,.30); }
    input, select, textarea { width: 100%; background: rgba(0,0,0,.25); color:#e9eef7; border:1px solid rgba(255,255,255,.12); border-radius: 10px; padding:10px 10px; box-sizing: border-box; }
    textarea { min-height: 80px; resize: vertical; }
    label { font-size: 12px; opacity: .8; display:block; margin: 8px 0 6px; }
    .task { display:grid; grid-template-columns: 24px 1fr auto; gap: 10px; align-items:start; padding: 10px; border-radius: 12px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); margin-bottom: 10px; }
    .task small { opacity: .75; display:block; margin-top: 3px; }
    .tag { font-size: 11px; opacity:.85; padding: 3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); }
    .done { opacity: .6; }
    .done .title { text-decoration: line-through; }
    .meta { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    footer { position: fixed; left: 0; right:0; bottom:0; padding: 10px 12px; border-top:1px solid rgba(255,255,255,.10); background: rgba(11,15,20,.92); backdrop-filter: blur(10px); }
    .footerbar { max-width: 880px; margin: 0 auto; display:flex; gap: 10px; }
    .grow { flex: 1; }
    .hint { font-size:12px; opacity:.75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
<header>
  <h1>Plan Oso & Ponky</h1>
  <div class="sub">Checklist diario + notas + recordatorios. Todo se guarda en tu tel√©fono.</div>
</header>

<main>
  <div class="row">
    <section class="card">
      <h2>Hoy</h2>
      <div class="meta">
        <span class="pill">üìÖ <span id="todayLabel"></span></span>
        <span class="pill">üî• Racha: <b id="streak">0</b> d√≠as</span>
        <span class="pill">‚úÖ Completado hoy: <b id="pct">0%</b></span>
      </div>

      <div style="margin-top:12px" id="taskList"></div>

      <div class="grid2">
        <button class="btn" id="markAll">Marcar todo (hoy)</button>
        <button class="btn danger" id="clearToday">Desmarcar hoy</button>
      </div>
    </section>

    <aside class="card">
      <h2>Agregar tarea</h2>
      <label>Nombre</label>
      <input id="newTitle" placeholder="Ej: Presencia sin disponibilidad (5 min)" />
      <label>Etiqueta</label>
      <select id="newTag">
        <option>Separaci√≥n</option>
        <option>Reactividad</option>
        <option>Recursos</option>
        <option>Paseo</option>
        <option>Calma</option>
      </select>
      <label>Frecuencia</label>
      <select id="newFreq">
        <option value="daily">Diaria</option>
        <option value="custom">Personalizada (d√≠as)</option>
      </select>
      <div id="customDaysWrap" style="display:none">
        <label>D√≠as (0=Dom ‚Ä¶ 6=S√°b) separados por coma</label>
        <input id="customDays" class="mono" placeholder="Ej: 1,2,3,4,5" />
        <div class="hint">Ej: 1‚Äì5 para lunes a viernes.</div>
      </div>

      <label>Descripci√≥n (opcional)</label>
      <textarea id="newDesc" placeholder="Ej: Oso atr√°s, Ponky adelante. 90¬∞ turn si aparece gato."></textarea>

      <button class="btn primary" id="addTask" style="margin-top:10px;width:100%">+ Agregar</button>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

      <h2>Recordatorios</h2>
      <div class="hint">Notificaci√≥n del navegador (funciona mejor si dejas la app abierta). Tambi√©n puedes descargar un evento para tu calendario.</div>

      <label>Hora del recordatorio diario</label>
      <input id="remTime" type="time" />
      <div class="grid2" style="margin-top:10px">
        <button class="btn" id="enableNotifs">Activar notificaciones</button>
        <button class="btn" id="testNotif">Probar</button>
      </div>

      <label style="margin-top:12px">Exportar a Calendario (.ics)</label>
      <button class="btn" id="downloadIcs">Descargar recordatorio</button>

      <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

      <h2>Datos</h2>
      <div class="grid2">
        <button class="btn" id="exportJson">Exportar JSON</button>
        <button class="btn danger" id="resetAll">Borrar todo</button>
      </div>
      <input type="file" id="importJson" accept="application/json" style="margin-top:10px" />
      <div class="hint">Exporta por si cambias de tel√©fono.</div>
    </aside>
  </div>
</main>

<footer>
  <div class="footerbar">
    <button class="btn grow" id="addDefaults">Cargar plan sugerido</button>
    <button class="btn grow" id="notesBtn">Notas del d√≠a</button>
  </div>
</footer>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const fmtDate = (d) => d.toISOString().slice(0,10);
  const today = () => {
    const d = new Date();
    d.setHours(0,0,0,0);
    return d;
  };
  const weekday = (d) => d.getDay(); // 0..6
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  // ---------- storage ----------
  const KEY = "oso_ponky_plan_v1";
  const load = () => {
    try { return JSON.parse(localStorage.getItem(KEY)) || null; }
    catch { return null; }
  };
  const save = (state) => localStorage.setItem(KEY, JSON.stringify(state));

  // ---------- initial state ----------
  const defaultState = {
    tasks: [],
    doneByDate: {}, // { "YYYY-MM-DD": { taskId: true } }
    notesByDate: {}, // { "YYYY-MM-DD": "..." }
    reminderTime: "20:30",
    notifEnabled: false,
    lastStreakCheck: null,
  };

  let state = load() || defaultState;

  // ---------- tasks ----------
  function isTaskScheduledFor(task, dateObj) {
    if (task.freq === "daily") return true;
    if (task.freq === "custom") {
      const wd = weekday(dateObj);
      return task.days.includes(wd);
    }
    return true;
  }

  function todaysTasks(dateObj) {
    return state.tasks.filter(t => isTaskScheduledFor(t, dateObj));
  }

  function ensureDoneMap(dateStr) {
    if (!state.doneByDate[dateStr]) state.doneByDate[dateStr] = {};
  }

  // ---------- streak ----------
  function computeStreak() {
    // Streak = consecutive days ending today where >=60% tasks scheduled were completed
    const t = today();
    let streak = 0;
    for (let i=0; i<365; i++) {
      const d = new Date(t);
      d.setDate(t.getDate() - i);
      const ds = fmtDate(d);
      const tasks = todaysTasks(d);
      if (tasks.length === 0) continue;
      ensureDoneMap(ds);
      const doneCount = tasks.filter(x => state.doneByDate[ds][x.id]).length;
      const pct = doneCount / tasks.length;
      if (pct >= 0.60) streak++;
      else break;
    }
    return streak;
  }

  // ---------- render ----------
  function render() {
    const t = today();
    const ds = fmtDate(t);
    $("todayLabel").textContent = ds;
    $("remTime").value = state.reminderTime || "20:30";

    ensureDoneMap(ds);
    const tasks = todaysTasks(t);

    const list = $("taskList");
    list.innerHTML = "";
    if (tasks.length === 0) {
      list.innerHTML = `<div class="hint">No tienes tareas todav√≠a. Usa "Cargar plan sugerido" abajo o agrega una.</div>`;
    } else {
      tasks.forEach(task => {
        const done = !!state.doneByDate[ds][task.id];
        const div = document.createElement("div");
        div.className = "task" + (done ? " done" : "");
        div.innerHTML = `
          <input type="checkbox" ${done ? "checked" : ""} aria-label="done"/>
          <div>
            <div class="title"><b>${escapeHtml(task.title)}</b> <span class="tag">${escapeHtml(task.tag)}</span></div>
            ${task.desc ? `<small>${escapeHtml(task.desc)}</small>` : `<small class="hint">Sin descripci√≥n</small>`}
          </div>
          <button class="btn danger" title="Eliminar">üóëÔ∏è</button>
        `;
        const cb = div.querySelector("input");
        const del = div.querySelector("button");

        cb.addEventListener("change", () => {
          state.doneByDate[ds][task.id] = cb.checked;
          save(state);
          render();
        });

        del.addEventListener("click", () => {
          // delete task from list and all done maps
          state.tasks = state.tasks.filter(x => x.id !== task.id);
          for (const dkey of Object.keys(state.doneByDate)) delete state.doneByDate[dkey][task.id];
          save(state);
          render();
        });

        list.appendChild(div);
      });
    }

    const doneCount = tasks.filter(x => state.doneByDate[ds][x.id]).length;
    const pct = tasks.length ? Math.round((doneCount / tasks.length) * 100) : 0;
    $("pct").textContent = pct + "%";
    $("streak").textContent = computeStreak();
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ---------- add task ----------
  $("newFreq").addEventListener("change", () => {
    $("customDaysWrap").style.display = $("newFreq").value === "custom" ? "block" : "none";
  });

  $("addTask").addEventListener("click", () => {
    const title = $("newTitle").value.trim();
    if (!title) return alert("Pon un nombre de tarea.");
    const tag = $("newTag").value;
    const freq = $("newFreq").value;
    let days = [];
    if (freq === "custom") {
      const raw = $("customDays").value.trim();
      if (!raw) return alert("Indica d√≠as (0..6) o cambia a diaria.");
      days = raw.split(",").map(x => parseInt(x.trim(),10)).filter(n => Number.isFinite(n) && n>=0 && n<=6);
      if (!days.length) return alert("Formato de d√≠as inv√°lido.");
    }
    const desc = $("newDesc").value.trim();
    state.tasks.push({ id: uid(), title, tag, freq, days, desc });
    $("newTitle").value = "";
    $("newDesc").value = "";
    $("customDays").value = "";
    save(state);
    render();
  });

  // ---------- defaults ----------
  $("addDefaults").addEventListener("click", () => {
    const defaults = [
      { title:"Presencia sin disponibilidad (5‚Äì10 min)", tag:"Separaci√≥n", freq:"daily", days:[], desc:"T√∫ en otra pieza, puerta cerrada, sin hablar/ mirar. Objetivo: bajar vigilancia de Oso." },
      { title:"Micro-salida (30‚Äì180 s) + retorno neutro", tag:"Separaci√≥n", freq:"daily", days:[], desc:"Sales/entras sin saludo 2‚Äì3 min. Ponky con tarea calmante; Oso sin premio especial." },
      { title:"Paseo calmado (sin buscar est√≠mulos)", tag:"Paseo", freq:"daily", days:[], desc:"Ritmo constante. Mejor volver aburridos que pasados de rosca." },
      { title:"Turno de olfato (5 min)", tag:"Calma", freq:"daily", days:[], desc:"B√∫squeda de comida escondida o alfombra olfativa. Cero persecuci√≥n." },
      { title:"Entrenamiento reactividad: giro 90¬∞ temprano", tag:"Reactividad", freq:"custom", days:[1,3,5], desc:"Si aparece gato: no √≥rdenes, no premios; giro y caminas. Oso atr√°s, Ponky adelante." },
      { title:"Manejo de recursos: comida/juguetes separados", tag:"Recursos", freq:"daily", days:[], desc:"Nada de premios dispersos juntos. Si Oso acapara: interrupci√≥n + pierde acceso." },
      { title:"Sesi√≥n corta separados (10‚Äì15 min)", tag:"Calma", freq:"custom", days:[2,4], desc:"Uno sale contigo, el otro queda con ruido blanco + tarea. Objetivo: desacoplar." },
    ];
    // no duplicar por t√≠tulo
    const existing = new Set(state.tasks.map(t => t.title));
    defaults.forEach(d => { if (!existing.has(d.title)) state.tasks.push({ id: uid(), ...d }); });
    save(state);
    render();
  });

  // ---------- today controls ----------
  $("markAll").addEventListener("click", () => {
    const ds = fmtDate(today());
    ensureDoneMap(ds);
    todaysTasks(today()).forEach(t => state.doneByDate[ds][t.id] = true);
    save(state); render();
  });
  $("clearToday").addEventListener("click", () => {
    const ds = fmtDate(today());
    ensureDoneMap(ds);
    todaysTasks(today()).forEach(t => delete state.doneByDate[ds][t.id]);
    save(state); render();
  });

  // ---------- notes ----------
  $("notesBtn").addEventListener("click", () => {
    const ds = fmtDate(today());
    const current = state.notesByDate[ds] || "";
    const txt = prompt("Notas de hoy (gatillos, progreso, conflictos, etc.)", current);
    if (txt === null) return;
    state.notesByDate[ds] = txt.trim();
    save(state);
    alert("Notas guardadas.");
  });

  // ---------- notifications ----------
  async function requestNotifs() {
    if (!("Notification" in window)) {
      alert("Este navegador no soporta notificaciones.");
      return false;
    }
    const perm = await Notification.requestPermission();
    state.notifEnabled = (perm === "granted");
    save(state);
    return state.notifEnabled;
  }

  function scheduleLoop() {
    // Simple loop: checks every 20s while app is open
    setInterval(() => {
      if (!state.notifEnabled || Notification.permission !== "granted") return;
      const now = new Date();
      const hhmm = now.toTimeString().slice(0,5);
      const target = state.reminderTime || "20:30";
      // fire once per day
      const ds = fmtDate(today());
      const key = "notified_" + ds + "_" + target;
      if (hhmm === target && !sessionStorage.getItem(key)) {
        sessionStorage.setItem(key, "1");
        new Notification("Oso & Ponky: recordatorio", {
          body: "Marca tu plan de hoy (separaci√≥n, reactividad, recursos).",
        });
      }
    }, 20000);
  }

  $("enableNotifs").addEventListener("click", async () => {
    const ok = await requestNotifs();
    alert(ok ? "Listo. Si dejas la app abierta, te avisar√° a la hora." : "No se activaron notificaciones.");
  });

  $("testNotif").addEventListener("click", async () => {
    if (Notification.permission !== "granted") {
      const ok = await requestNotifs();
      if (!ok) return;
    }
    new Notification("Prueba: Plan Oso & Ponky", { body: "Notificaci√≥n OK." });
  });

  $("remTime").addEventListener("change", () => {
    state.reminderTime = $("remTime").value || "20:30";
    save(state);
  });

  // ---------- calendar export (.ics) ----------
  function downloadText(filename, text) {
    const blob = new Blob([text], { type: "text/calendar;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function icsForDailyReminder(timeHHMM) {
    // Creates a daily event with an alarm 0 minutes before.
    // User can adjust in calendar app.
    const [hh, mm] = timeHHMM.split(":").map(x=>parseInt(x,10));
    const start = new Date();
    start.setHours(hh, mm, 0, 0);
    // DTSTART in local time (floating)
    const pad = (n)=> String(n).padStart(2,"0");
    const dt = `${start.getFullYear()}${pad(start.getMonth()+1)}${pad(start.getDate())}T${pad(hh)}${pad(mm)}00`;
    const uidVal = uid() + "@oso-ponky";
    return [
      "BEGIN:VCALENDAR",
      "VERSION:2.0",
      "PRODID:-//Plan Oso Ponky//ES",
      "BEGIN:VEVENT",
      `UID:${uidVal}`,
      `DTSTART:${dt}`,
      "RRULE:FREQ=DAILY",
      "SUMMARY:Plan Oso & Ponky (marcar avances)",
      "DESCRIPTION:Recordatorio diario para registrar avances del plan.",
      "BEGIN:VALARM",
      "TRIGGER:-PT0M",
      "ACTION:DISPLAY",
      "DESCRIPTION:Plan Oso & Ponky",
      "END:VALARM",
      "END:VEVENT",
      "END:VCALENDAR"
    ].join("\r\n");
  }

  $("downloadIcs").addEventListener("click", () => {
    const t = state.reminderTime || "20:30";
    downloadText("recordatorio_oso_ponky.ics", icsForDailyReminder(t));
  });

  // ---------- export/import ----------
  $("exportJson").addEventListener("click", () => {
    downloadText("plan_oso_ponky.json", JSON.stringify(state, null, 2));
  });

  $("importJson").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const txt = await file.text();
    try {
      const obj = JSON.parse(txt);
      state = obj;
      save(state);
      render();
      alert("Importado.");
    } catch {
      alert("Archivo inv√°lido.");
    }
  });

  $("resetAll").addEventListener("click", () => {
    if (!confirm("¬øSeguro? Esto borra todo.")) return;
    state = JSON.parse(JSON.stringify(defaultState));
    save(state);
    render();
  });

  // init
  if (!state.reminderTime) state.reminderTime = "20:30";
  save(state);
  render();
  scheduleLoop();
</script>
</body>
</html>
